#!/usr/bin/make -f

CMD=$(shell echo $@ | sed 's/override_//')

CONFIG_FILE=debian/config/$(shell lsb_release -is).h

%:
	dh --with quilt $@

override_dh_quilt_patch:
	ln -sf ../$(CONFIG_FILE) midori/midori-debian.h
	test -e midori/midori-debian.h
	$(CMD)

override_dh_auto_clean:
	./waf --nocache distclean
	rm -rf _build_

override_dh_auto_configure:
	./waf --nocache configure --prefix /usr

override_dh_auto_build:
	./waf --nocache build --debug full

override_dh_auto_test:
	@echo tests are broken
#	xvfb-run ./waf --nocache check

override_dh_auto_install:
	./waf --nocache install --destdir debian/tmp
	rm -f debian/tmp/usr/share/doc/midori/COPYING debian/tmp/usr/share/doc/midori/TRANSLATE

PRIORITY=$(shell sed -r -e '/DEBIAN_WWW_ALTERNATIVES_PRIORITY/ !d' -e 's/.* ([^ ]*)$$/\1/' $(CONFIG_FILE))

debian/midori.postinst: debian/midori.postinst.base
	sed "s/DEBIAN_WWW_ALTERNATIVES_PRIORITY/$(PRIORITY)/g" debian/midori.postinst.base > debian/midori.postinst

override_dh_installdeb: debian/midori.postinst
	$(CMD)

override_dh_strip:
	$(CMD) --dbg-package=midori-dbg
